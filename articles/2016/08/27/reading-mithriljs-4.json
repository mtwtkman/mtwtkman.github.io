{"title": "mithriljs\u306e\u30b3\u30fc\u30c9\u3092\u8aad\u3080(4)", "body": "\u524d\u56de\u306f`buildArray`\u307e\u3067\u8aad\u3093\u3060\u3002`buildObject`\u304b\u3089\u8aad\u3082\u3046\u3067\u306f\u306a\u3044\u304b\u3002\n\n[\u3053\u3053](https://github.com/lhorie/mithril.js/blob/0159cd667ad85cd82d92fcb31a33f75be6539f6d/mithril.js#L831)\n\n```javascript\nfunction buildObject( // eslint-disable-line max-statements\n  data,\n  cached,\n  editable,\n  parentElement,\n  index,\n  shouldReattach,\n  namespace,\n  configs\n) {\n  var views = []\n  var controllers = []\n\n  data = markViews(data, cached, views, controllers)\n```\n\n`data`\u304c\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u5834\u5408\u3001\u3064\u307e\u308a\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u306e\u5834\u5408\u306f`markViews`\u3067\u4f55\u304b\u3092\u3057\u3066\u3044\u308b\u3002\u898b\u3066\u307f\u308b\u3002\n\n```javascript\nfunction markViews(data, cached, views, controllers) {\n  var cachedControllers = cached && cached.controllers\n\n  while (data.view != null) {\n    data = checkView(\n      data,\n      data.view.$original || data.view,\n      cached,\n      cachedControllers,\n      controllers,\n      views)\n  }\n\n  return data\n```\n\n\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u3066\u3044\u308bController\u304c\u306a\u3044\u304b\u3092\u5224\u5b9a\u3057\u3066`checkView`\u304b\u3089`data`\u3092\u4f5c\u3063\u3066\u3044\u308b\u3002\u898b\u3066\u307f\u308b\u3002\n\n```javascript\nfunction checkView(\n  data,\n  view,\n  cached,\n  cachedControllers,\n  controllers,\n  views\n) {\n  var controller = getController(\n    cached.views,\n    view,\n    cachedControllers,\n    data.controller)\n\n  var key = data && data.attrs && data.attrs.key\n```\n\u30d0\u30b1\u30c4\u30ea\u30ec\u30fc\u3067\u982d\u304c\u30d5\u30c3\u30c8\u30fc\u3057\u305d\u3046\u3060\u304c\u3001`getController`\u3067Controller\u3092\u53d6\u5f97\u3057\u3066\u3044\u308b\u306e\u306f\u660e\u767d\u3060\u3002\u3055\u3089\u306b\u3001`data`\u306e`key`\u3092\u53d6\u5f97\u3057\u3066\u3044\u308b\u3002\n\n\u3053\u306e\u8fba\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u3066\u3044\u308b\u4eee\u60f3DOM\u3092\u30a2\u30ec\u30b3\u30ec\u3059\u308b\u305f\u3081\u3060\u308d\u3046\u3002`getController`\u3092\u898b\u3066\u307f\u308b\u3002\n\n```javascript\nfunction getController(views, view, cachedControllers, controller) {\n  var controllerIndex\n\n  if (m.redraw.strategy() === \"diff\" && views) {\n    controllerIndex = views.indexOf(view)\n  } else {\n    controllerIndex = -1\n  }\n\n  if (controllerIndex > -1) {\n    return cachedControllers[controllerIndex]\n  } else if (isFunction(controller)) {\n    return new controller()\n  } else {\n    return {}\n  }\n}\n```\n\n\u5dee\u5206\u63cf\u753b\u306e\u30d5\u30e9\u30b0\u3067\u4e14\u3064\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308c\u3070\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u3066\u3044\u308bController\u3092\u8fd4\u3057\u3001\u305d\u3046\u3067\u306a\u3051\u308c\u3070\u5f15\u6570\u306e`controller`\u3092\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u5316\u3059\u308b\u304b\u7a7a\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\u3002\n\n\u307e\u3042\u305d\u306e\u540d\u306e\u901a\u308aController\u3092\u8fd4\u3057\u3066\u3044\u308b\u3060\u3051\u3060\u3002\n\n`checkView`\u306b\u623b\u308b\u3068\n\n```javascript\n  if (pendingRequests === 0 ||\n      forcing ||\n      cachedControllers &&\n        cachedControllers.indexOf(controller) > -1) {\n    data = data.view(controller)\n  } else {\n    data = {tag: \"placeholder\"}\n  }\n```\n\n\u3053\u306eif\u6587\u306f\u518d\u63cf\u753b\u3092\u884c\u3048\u308b\u72b6\u614b\u304b\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u3066\u3044\u308bController\u304c\u5b58\u5728\u3057\u3066\u3044\u308b\u5834\u5408\u306b\u4eee\u60f3DOM(`data.view`\u306ereturn)\u3092`data`\u306b\u518d\u4ee3\u5165\u3057\u3066\u3044\u308b\u3002\n\n```javascript\n\n  if (data.subtree === \"retain\") return data\n  data.attrs = data.attrs || {}\n  data.attrs.key = key\n  updateLists(views, controllers, view, controller)\n  return data\n}\n```\n\n`data.subtree === \"retain\"`\u3067\u3042\u308c\u3070`data`\u306e\u66f4\u65b0\u306f\u884c\u308f\u306a\u3044\u3002\u3053\u3053\u306f[\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u3072\u3063\u305d\u308a\u3068\u66f8\u3044\u3066\u3042\u308b\u3002](http://mithril.js.org/mithril.html#persisting-dom-elements-across-route-changes)\n\n\u6982\u8981\u3092\u66f8\u304f\u3068\u3001retain\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3068`router`\u306b\u3088\u308b\u753b\u9762\u518d\u63cf\u753b\u6642\u306b\u305d\u306eDOM\u306f\u518d\u69cb\u7bc9\u3055\u308c\u305a\u306b\u305d\u306e\u307e\u307e\u5f15\u304d\u7d99\u304c\u308c\u308b\u3068\u3044\u3046\u3082\u306e\u3002\n\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u3092\u4f7f\u3044\u56de\u3059\u6642\u306a\u3069\u306b\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3002(\u3053\u306e\u6587\u8108\u3067\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u306f`data`\u306e\u3053\u3068)\n\n\u3067\u3001\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u3092\u30ad\u30e3\u30c3\u30b7\u30e5\u3057\u3066\u3044\u308b`views`\u3068`controllers`\u306b\u4f5c\u6210\u3057\u305f`view`\u3068`controller`\u7a81\u3063\u8fbc\u3093\u3067\u3044\u308b\u3002\n\n`buildObject`\u306b\u623b\u308a\u307e\u3059\u3002\n\n```javascript\n  if (data.subtree === \"retain\") return cached\n```\n\n\u4e0a\u8ff0\u3057\u305f\u901a\u308a\u3001retain\u306e\u6642\u306f\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u3092\u4f7f\u3044\u56de\u3059\u3002\n\n```javascript\n\n  if (!data.tag && controllers.length) {\n    throw new Error(\"Component template must return a virtual \" +\n      \"element, not an array, string, etc.\")\n  }\n\n  data.attrs = data.attrs || {}\n  cached.attrs = cached.attrs || {}\n\n  var dataAttrKeys = Object.keys(data.attrs)\n  var hasKeys = dataAttrKeys.length > (\"key\" in data.attrs ? 1 : 0)\n\n  maybeRecreateObject(data, cached, dataAttrKeys)\n```\n\n\u3053\u3053\u304b\u3089\u306fconfig\u306e\u8a2d\u5b9a\u304b\u306a\u3002`maybeRecreateObject`\u3092\u898b\u3066\u307f\u308b\u3002\n\n```javascript\nfunction maybeRecreateObject(data, cached, dataAttrKeys) {\n  // if an element is different enough from the one in cache, recreate it\n  if (isDifferentEnough(data, cached, dataAttrKeys)) {\n    if (cached.nodes.length) clear(cached.nodes)\n\n    if (cached.configContext &&\n        isFunction(cached.configContext.onunload)) {\n      cached.configContext.onunload()\n    }\n\n    if (cached.controllers) {\n      forEach(cached.controllers, function (controller) {\n        if (controller.onunload) {\n          controller.onunload({preventDefault: noop})\n        }\n      })\n    }\n  }\n}\n```\n\n\u5dee\u5206\u304c\u3042\u3063\u305f\u6642\u306b\u518d\u4f5c\u6210\u3059\u308b\u3088\u3046\u306a\u8981\u7d20\u3060\u3063\u305f\u5834\u5408\u306b\u518d\u4f5c\u6210\u3057\u3066\u3044\u308b\u3002\u3067\u3001`diffrent enough`\u3067\u3042\u308b\u3053\u3068\u3092`isDifferentEnough`\u3067\u898b\u3066\u3044\u308b\u3002\n\n```javascript\nfunction isDifferentEnough(data, cached, dataAttrKeys) {\n  if (data.tag !== cached.tag) return true\n\n  if (dataAttrKeys.sort().join() !==\n      Object.keys(cached.attrs).sort().join()) {\n    return true\n  }\n\n  if (data.attrs.id !== cached.attrs.id) {\n    return true\n  }\n\n  if (data.attrs.key !== cached.attrs.key) {\n    return true\n  }\n\n  if (m.redraw.strategy() === \"all\") {\n    return !cached.configContext || cached.configContext.retain !== true\n  }\n\n  if (m.redraw.strategy() === \"diff\") {\n    return cached.configContext && cached.configContext.retain === false\n  }\n\n  return false\n}\n```\n\ntrue\u306b\u306a\u308b\u306e\u306f\n- attributes\u306e\u30ad\u30fc\u304c\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u3066\u3044\u308b\u306e\u3068\u7570\u306a\u308b\u6642\n- attrs\u306eid\u304c\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u3066\u3044\u308b\u306e\u3068\u7570\u306a\u308b\u6642\n- `key`\u304c\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u3066\u3044\u308b\u306e\u3068\u7570\u306a\u308b\u6642\n- strategy\u304c`all`\u3067\u304b\u3064\u3001`config`\u304c\u306a\u3044\u307e\u305f\u306fretain\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u306a\u3044\u6642\n- strategy\u304c`diff`\u3067\u304b\u3064\u3001`config`\u304c\u3042\u3063\u3066retain\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u306a\u3044\u6642\n\n\u3061\u306a\u307f\u306b\u3001strategy\u306f\u2193\u306e\u901a\u308a\n| all | \u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u5024\u3002redraw\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u73fe\u5728\u306eDOM\u3092\u6368\u3066\u3066\u5168\u90e8\u4f5c\u308a\u76f4\u3059|\n| diff | \u5dee\u5206\u304c\u3042\u3063\u305f\u3068\u304d\u3060\u3051\u305d\u306e\u5dee\u5206\u66f4\u65b0\u3092\u884c\u3046 |\n| none | redraw\u3092\u3059\u3063\u98db\u3070\u3059\u3002\u4f55\u3082\u66f4\u65b0\u306f\u3057\u306a\u3044 |\n\n`all`\u3067\u304b\u3064`config`\u304c\u306a\u3044\u6642\u3068\u3044\u3046\u306e\u304c\u30d4\u30f3\u3068\u3053\u306a\u3044\u304c\u3001\u304a\u305d\u3089\u304f`config`\u306f`redraw`\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u5e38\u306b\u547c\u3070\u308c\u308b\u304b\u3089\u30ad\u30e3\u30c3\u30b7\u30e5\u524d\u63d0\u306e\u305f\u3081\u3060\u308d\u3046\u3002\n\n```javascript\n\n  if (!isString(data.tag)) return\n```\n\n\u3053\u3053\u306f\u3069\u3046\u3044\u3046\u3053\u3068\u3060\u304b\u3088\u304f\u308f\u304b\u3089\u306a\u3044\u3002`tag`\u304c\u6587\u5b57\u578b\u3067\u306a\u3051\u308c\u3070\u30a8\u30e9\u30fc\u3067\u306f\u306a\u304f\u7121\u3092\u8fd4\u3059\u2026\u3069\u3046\u3044\u3046\u3053\u3068\u3060\u2026\n\n[m()\u3067\u306f\u30a8\u30e9\u30fc\u306b\u3057\u3066\u308b\u305e?](https://github.com/lhorie/mithril.js/blob/0159cd667ad85cd82d92fcb31a33f75be6539f6d/mithril.js#L168-L171)\n\n\u3088\u304f\u308f\u304b\u3089\u306a\u3044\u306e\u3067gitter\u3067\u805e\u3044\u3066\u308b\u4e2d\u3002\n\n```javascript\n  var isNew = cached.nodes.length === 0\n\n  namespace = getObjectNamespace(data, namespace)\n  var node\n  if (isNew) {\n    node = constructNode(data, namespace)\n```\n\u3053\u3053\u3067DOM\u4f5c\u3063\u3066\u308b\u3002\n\n```javascript\n    // set attributes first, then create children\n    var attrs = constructAttrs(data, node, namespace, hasKeys)\n```\n\nDOM\u306b\u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u3092\u30bb\u30c3\u30c8\n\n```javascript\n    // add the node to its parent before attaching children to it\n    insertNode(parentElement, node, index)\n```\n\n\u5b50\u30ce\u30fc\u30c9\u3068\u3057\u3066\u89aa\u8981\u7d20\u306b\u8ffd\u52a0\n\n```javascript\n    var children = constructChildren(data, node, cached, editable,\n      namespace, configs)\n```\n\n\u5b50\u30ce\u30fc\u30c9\u3092\u4f5c\u6210\u3002\u3053\u306e\u4e2d\u3067\u3055\u3089\u306b`build`\u3092\u547c\u3093\u3067\u5b50\u30ce\u30fc\u30c9\u306eDOM\u3092\u4f5c\u6210\u3057\u3066\u3044\u308b\u3002\n\n```javascript\n    cached = reconstructCached(\n      data,\n      attrs,\n      children,\n      node,\n      namespace,\n      views,\n      controllers)\n  } else {\n    node = buildUpdatedNode(\n      cached,\n      data,\n      editable,\n      hasKeys,\n      namespace,\n      views,\n      configs,\n      controllers)\n  }\n\n```\n\n\u521d\u56de\u306e`build`\u3067\u3042\u308c\u3070\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u4f5c\u308a\u3001\u305d\u3046\u3067\u306a\u3051\u308c\u3070`data`\u306e\u60c5\u5831\u3067`cached`\u3092\u66f4\u65b0\u3059\u308b\u3002\n\n```javascript\n  // edge case: setting value on <select> doesn't work before children\n  // exist, so set it again after children have been created/updated\n  if (data.tag === \"select\" && \"value\" in data.attrs) {\n    setAttributes(node, data.tag, {value: data.attrs.value}, {},\n      namespace)\n  }\n  if (!isNew && shouldReattach === true && node != null) {\n    insertNode(parentElement, node, index)\n  }\n\n  // The configs are called after `build` finishes running\n  scheduleConfigsToBeCalled(configs, data, node, isNew, cached)\n\n  return cached\n}\n```\n\u3069\u3046\u3084\u3089select\u30bf\u30b0\u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u305f\u5834\u5408\u306f\u5b50\u8981\u7d20\u304c\u306a\u3044\u3068\u3046\u307e\u304f\u52d5\u304b\u306a\u3044\u3068\u306e\u3053\u3068\u3067\u3082\u3046\u4e00\u5ea6\u5c5e\u6027\u306e\u8a2d\u5b9a\u3092\u3057\u3066\u3044\u308b\u3002\n\n\u3067\u3001\u5fc5\u8981\u306b\u5fdc\u3058\u3066`node`\u3092`index`\u306e\u4f4d\u7f6e\u306b\u8ffd\u52a0\u3057\u3066\u6700\u5f8c\u306b`data`\u306e`config`\u3092`configs`\u306b\u7a81\u3063\u8fbc\u3093\u3067\u7d42\u4e86\u3002\n\n\n\u3068\u308a\u3042\u3048\u305a\u3053\u308c\u3067\u304a\u3057\u307e\u3044\u306a\u3093\u3060\u304c\u3001\u307e\u3060\u3042\u308b\u3093\u3084\u2026", "publish": true, "tags": ["javascript", "mithril"], "date": "2016/08/27 20:18:23", "slug": "reading-mithriljs-4"}